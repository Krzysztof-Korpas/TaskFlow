@model int
@{
    ViewData["Title"] = Localizer["Project.KanbanBoard"].Value;
}

<div id="app">
    <div class="page-header">
        <a href="/" class="btn btn-secondary" style="margin-right: 0.5rem;">← {{ t('Nav.Projects') }}</a>
        <a v-if="project" :href="'/projects/' + projectId" class="btn btn-secondary" style="margin-right: 1rem;">{{ t('Project.TaskList') }}</a>
        <h1 v-if="project">{{ project.key }} – {{ project.name }}</h1>
        <button class="btn btn-primary" @@click="showCreateTicket = true">{{ t('Project.NewTask') }}</button>
        <button class="btn btn-secondary" style="margin-left: 0.5rem;" @@click="openColumnsModal">{{ t('Project.ManageColumns') }}</button>
    </div>
    <div v-if="loading" class="loading">{{ t('Projects.Loading') }}</div>
    <div v-if="error" class="error">{{ error }}</div>
    <div class="kanban-board" v-show="!loading && !error">
        <div
            v-for="col in visibleColumns"
            :key="col.statusId"
            class="kanban-column"
            :data-status="col.statusId"
            @@dragover.prevent="onDragOver($event, col.statusId)"
            @@dragleave="onDragLeave($event)"
            @@drop="onDrop($event, col.statusId)"
            :class="{ 'kanban-column--drag-over': dragOverColumn === col.statusId }"
        >
            <div class="kanban-column-header">
                <span class="kanban-column-title">{{ col.statusName }}</span>
                <span class="kanban-column-count">{{ ticketsByStatus(col.statusId).length }}</span>
            </div>
            <div class="kanban-column-cards">
                <a
                    v-for="ticket in ticketsByStatus(col.statusId)"
                    :key="ticket.id"
                    :href="'/tickets/' + ticket.key"
                    class="kanban-card"
                    draggable="true"
                    @@dragstart="onDragStart($event, ticket)"
                    @@dragend="onDragEnd"
                >
                    <span class="kanban-card-key">{{ ticket.key }}</span>
                    <span :class="'badge badge-' + statusClass(ticket.statusId)" class="kanban-card-status">{{ ticket.statusName || fallbackStatusName(ticket.statusId) }}</span>
                    <span :class="'badge badge-' + priorityClass(ticket.priority)" class="kanban-card-priority">{{ priorityLabel(ticket.priority) }}</span>
                    <div class="kanban-card-title">{{ ticket.title }}</div>
                    <div class="kanban-card-meta">{{ ticket.assigneeName || t('Ticket.Unassigned') }}</div>
                </a>
            </div>
        </div>
    </div>

    <div v-if="showCreateTicket" class="modal-overlay" @@click.self="showCreateTicket = false">
        <div class="modal">
            <h2>{{ t('Project.NewTask') }}</h2>
            <div class="form-group">
                <label>{{ t('Ticket.TitleLabel') }}</label>
                <input v-model="newTicket.title" :placeholder="t('Ticket.TitlePlaceholder')" />
            </div>
            <div class="form-group">
                <label>{{ t('Ticket.DescriptionLabel') }}</label>
                <textarea v-model="newTicket.description" rows="3" :placeholder="t('Ticket.DescriptionPlaceholder')"></textarea>
            </div>
            <div class="form-group">
                <label>{{ t('Ticket.TypeLabel') }}</label>
                <select v-model="newTicket.type">
                    <option value="0">{{ t('Ticket.TypeTask') }}</option>
                    <option value="1">{{ t('Ticket.TypeBug') }}</option>
                    <option value="2">{{ t('Ticket.TypeFeature') }}</option>
                    <option value="3">{{ t('Ticket.TypeOther') }}</option>
                </select>
            </div>
            <div class="form-group">
                <label>{{ t('Ticket.PriorityLabel') }}</label>
                <select v-model="newTicket.priority">
                    <option value="0">{{ t('Ticket.PriorityLowest') }}</option>
                    <option value="1">{{ t('Ticket.PriorityLow') }}</option>
                    <option value="2">{{ t('Ticket.PriorityMedium') }}</option>
                    <option value="3">{{ t('Ticket.PriorityHigh') }}</option>
                    <option value="4">{{ t('Ticket.PriorityHighest') }}</option>
                </select>
            </div>
            <div class="form-group">
                <label>{{ t('Ticket.AssignToLabel') }}</label>
                <select v-model="newTicket.assigneeId">
                    <option :value="null">—</option>
                    <option v-for="u in users" :key="u.id" :value="u.id">{{ u.displayName }}</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" @@click="showCreateTicket = false">{{ t('Projects.Cancel') }}</button>
                <button class="btn btn-primary" @@click="createTicket">{{ t('Projects.Create') }}</button>
            </div>
        </div>
    </div>

    <div v-if="showColumnsModal" class="modal-overlay" @@click.self="showColumnsModal = false">
        <div class="modal">
            <h2>{{ t('Project.ColumnSettings') }}</h2>
            <div class="form-group">
                <label>{{ t('Project.AddStatus') }}</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input v-model="newStatusName" :placeholder="t('Project.StatusNamePlaceholder')" />
                    <button class="btn btn-secondary" @@click="createStatus">{{ t('Projects.Create') }}</button>
                </div>
            </div>
            <div v-if="editableColumns.length === 0" style="color: var(--text-muted);">{{ t('Project.NoColumns') }}</div>
            <div v-else class="card" style="padding: 0.5rem;">
                <div v-for="(col, idx) in editableColumns" :key="col.statusId" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem 0;">
                    <input type="checkbox" v-model="col.isVisible" />
                    <span style="flex: 1;">{{ col.statusName }}</span>
                    <button class="btn btn-secondary btn-sm" @@click="moveColumn(idx, -1)" :disabled="idx === 0">↑</button>
                    <button class="btn btn-secondary btn-sm" @@click="moveColumn(idx, 1)" :disabled="idx === editableColumns.length - 1">↓</button>
                    <button class="btn btn-danger btn-sm" @@click="deleteStatus(col)">{{ t('Project.DeleteStatus') }}</button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" @@click="showColumnsModal = false">{{ t('Projects.Cancel') }}</button>
                <button class="btn btn-primary" @@click="saveColumns">{{ t('Project.SaveColumns') }}</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
const projectId = @Model;
const { createApp } = Vue;
const priorityKeys = { 0: 'Ticket.PriorityLowest', 1: 'Ticket.PriorityLow', 2: 'Ticket.PriorityMedium', 3: 'Ticket.PriorityHigh', 4: 'Ticket.PriorityHighest' };
createApp({
    data() {
        return {
            projectId,
            project: null,
            tickets: [],
            columns: [],
            users: [],
            loading: true,
            error: null,
            showCreateTicket: false,
            showColumnsModal: false,
            newStatusName: '',
            editableColumns: [],
            newTicket: { title: '', description: '', type: 0, priority: 2, assigneeId: null },
            dragOverColumn: null,
            draggedTicket: null,
            translations: {}
        };
    },
    computed: {
        visibleColumns() {
            return this.columns
                .filter(c => c.isVisible)
                .sort((a, b) => a.position - b.position);
        }
    },
    mounted() {
        this.loadTranslations().then(() => { this.load(); });
        fetch('/api/UsersApi').then(r => r.json()).then(u => this.users = u).catch(() => {});
    },
    methods: {
        async loadTranslations() {
            const locale = document.documentElement.lang || 'pl';
            try {
                const r = await fetch('/locales/' + locale + '.json');
                if (r.ok) this.translations = await r.json();
            } catch (_) {}
        },
        t(key, ...args) {
            let s = this.translations[key] ?? key;
            args.forEach((val, i) => { s = s.replace(new RegExp('\\{' + i + '\\}', 'g'), val); });
            return s;
        },
        normalizeStatusId(v) {
            const n = typeof v === 'string' ? parseInt(v, 10) : Number(v);
            return Number.isNaN(n) ? 0 : n;
        },
        ticketsByStatus(statusId) {
            return this.tickets.filter(t => this.normalizeStatusId(t.statusId) === statusId);
        },
        statusClass(statusId) {
            const sorted = this.visibleColumns;
            const index = sorted.findIndex(c => c.statusId === statusId);
            const c = { 0: 'todo', 1: 'progress', 2: 'review', 3: 'done' };
            return c[index] ?? 'neutral';
        },
        fallbackStatusName(statusId) {
            const col = this.columns.find(c => c.statusId === statusId);
            return col ? col.statusName : this.t('Ticket.Status');
        },
        priorityLabel(p) { return this.t(priorityKeys[p] ?? 'Ticket.PriorityMedium'); },
        priorityClass(p) {
            const c = { 0: 'lowest', 1: 'low', 2: 'medium', 3: 'high', 4: 'highest' };
            return c[p] ?? 'medium';
        },
        openColumnsModal() {
            this.editableColumns = this.columns
                .slice()
                .sort((a, b) => a.position - b.position)
                .map(c => ({ ...c }));
            this.showColumnsModal = true;
        },
        moveColumn(index, delta) {
            const target = index + delta;
            if (target < 0 || target >= this.editableColumns.length) return;
            const tmp = this.editableColumns[index];
            this.editableColumns[index] = this.editableColumns[target];
            this.editableColumns[target] = tmp;
        },
        async load() {
            try {
                this.loading = true;
                this.error = null;
                const [pRes, tRes, cRes] = await Promise.all([
                    fetch('/api/ProjectsApi/' + projectId),
                    fetch('/api/TicketsApi?projectId=' + projectId),
                    fetch('/api/KanbanApi/project/' + projectId + '/columns')
                ]);
                if (!pRes.ok) throw new Error(this.t('Project.ErrorLoad'));
                if (!tRes.ok) throw new Error(this.t('Project.ErrorLoadTickets'));
                if (!cRes.ok) throw new Error(this.t('Project.ErrorLoad'));
                this.project = await pRes.json();
                const rawTickets = await tRes.json();
                this.tickets = rawTickets.map(t => ({
                    ...t,
                    statusId: this.normalizeStatusId(t.statusId)
                }));
                const cols = await cRes.json();
                this.columns = cols.map(c => ({
                    statusId: this.normalizeStatusId(c.statusId),
                    statusName: c.statusName,
                    position: c.position,
                    isVisible: c.isVisible
                }));
            } catch (e) {
                this.error = e.message;
            } finally {
                this.loading = false;
            }
        },
        onDragStart(ev, ticket) {
            this.draggedTicket = ticket;
            ev.dataTransfer.effectAllowed = 'move';
            ev.dataTransfer.setData('text/plain', ticket.id);
            ev.target.classList.add('kanban-card--dragging');
        },
        onDragEnd(ev) {
            ev.target.classList.remove('kanban-card--dragging');
            this.draggedTicket = null;
            this.dragOverColumn = null;
        },
        onDragOver(ev, type) {
            if (this.draggedTicket && this.normalizeStatusId(this.draggedTicket.statusId) !== type) {
                this.dragOverColumn = type;
            }
        },
        onDragLeave(ev) {
            if (!ev.currentTarget.contains(ev.relatedTarget)) {
                this.dragOverColumn = null;
            }
        },
        async onDrop(ev, newType) {
            ev.preventDefault();
            this.dragOverColumn = null;
            const ticketId = ev.dataTransfer.getData('text/plain');
            if (!ticketId || !this.draggedTicket) return;
            const ticket = this.tickets.find(t => t.id === parseInt(ticketId, 10));
            if (!ticket || this.normalizeStatusId(ticket.statusId) === newType) return;
            try {
                const r = await fetch('/api/TicketsApi/' + ticketId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ statusId: newType })
                });
                if (!r.ok) throw new Error(this.t('Ticket.ErrorUpdate'));
                ticket.statusId = newType;
                ticket.statusName = this.fallbackStatusName(newType);
            } catch (e) {
                alert(e.message);
            }
        },
        async createTicket() {
            if (!this.newTicket.title.trim()) return;
            try {
                const r = await fetch('/api/TicketsApi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: this.newTicket.title,
                        description: this.newTicket.description || null,
                        projectId,
                        reporterId: 1,
                        assigneeId: this.newTicket.assigneeId || null,
                        type: parseInt(this.newTicket.type, 10),
                        priority: parseInt(this.newTicket.priority, 10)
                    })
                });
                if (!r.ok) throw new Error(this.t('Project.ErrorCreateTicket'));
                this.showCreateTicket = false;
                this.newTicket = { title: '', description: '', type: 0, priority: 2, assigneeId: null };
                await this.load();
            } catch (e) {
                alert(e.message);
            }
        },
        async createStatus() {
            const name = this.newStatusName.trim();
            if (!name) return;
            try {
                const r = await fetch('/api/KanbanApi/project/' + projectId + '/statuses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (!r.ok) throw new Error(await r.text());
                this.newStatusName = '';
                await this.load();
                this.openColumnsModal();
            } catch (e) {
                alert(e.message);
            }
        },
        async deleteStatus(col) {
            if (!confirm(this.t('Project.ConfirmDeleteStatus', col.statusName))) return;
            try {
                const r = await fetch('/api/KanbanApi/project/' + projectId + '/statuses/' + col.statusId, {
                    method: 'DELETE'
                });
                if (!r.ok) throw new Error(await r.text());
                await this.load();
                this.openColumnsModal();
            } catch (e) {
                alert(e.message);
            }
        },
        async saveColumns() {
            const normalized = this.editableColumns.map((c, idx) => ({
                statusId: c.statusId,
                statusName: c.statusName,
                position: idx,
                isVisible: !!c.isVisible
            }));
            try {
                const r = await fetch('/api/KanbanApi/project/' + projectId + '/columns', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ columns: normalized })
                });
                if (!r.ok) throw new Error(await r.text());
                const cols = await r.json();
                this.columns = cols.map(c => ({
                    statusId: this.normalizeStatusId(c.statusId),
                    statusName: c.statusName,
                    position: c.position,
                    isVisible: c.isVisible
                }));
                this.showColumnsModal = false;
            } catch (e) {
                alert(e.message);
            }
        }
    }
}).mount('#app');
</script>
}
