@model int
@{
    ViewData["Title"] = Localizer["Project.KanbanBoard"].Value;
}

<div id="app">
    <div class="page-header">
        <a href="/" class="btn btn-secondary" style="margin-right: 0.5rem;">← {{ t('Nav.Projects') }}</a>
        <a v-if="project" :href="'/projects/' + projectId" class="btn btn-secondary" style="margin-right: 1rem;">{{ t('Project.TaskList') }}</a>
        <h1 v-if="project">{{ project.key }} – {{ project.name }}</h1>
        <button class="btn btn-primary" @@click="showCreateTicket = true">{{ t('Project.NewTask') }}</button>
    </div>
    <div v-if="loading" class="loading">{{ t('Projects.Loading') }}</div>
    <div v-if="error" class="error">{{ error }}</div>
    <div class="kanban-board" v-show="!loading && !error">
        <div
            v-for="col in columns"
            :key="col.type"
            class="kanban-column"
            :data-type="col.type"
            @@dragover.prevent="onDragOver($event, col.type)"
            @@dragleave="onDragLeave($event)"
            @@drop="onDrop($event, col.type)"
            :class="{ 'kanban-column--drag-over': dragOverColumn === col.type }"
        >
            <div class="kanban-column-header">
                <span class="kanban-column-title">{{ col.label }}</span>
                <span class="kanban-column-count">{{ ticketsByType(col.type).length }}</span>
            </div>
            <div class="kanban-column-cards">
                <a
                    v-for="ticket in ticketsByType(col.type)"
                    :key="ticket.id"
                    :href="'/tickets/' + ticket.key"
                    class="kanban-card"
                    draggable="true"
                    @@dragstart="onDragStart($event, ticket)"
                    @@dragend="onDragEnd"
                >
                    <span class="kanban-card-key">{{ ticket.key }}</span>
                    <span :class="'badge badge-' + statusClass(ticket.status)" class="kanban-card-status">{{ statusLabel(ticket.status) }}</span>
                    <span :class="'badge badge-' + priorityClass(ticket.priority)" class="kanban-card-priority">{{ priorityLabel(ticket.priority) }}</span>
                    <div class="kanban-card-title">{{ ticket.title }}</div>
                    <div class="kanban-card-meta">{{ ticket.assigneeName || t('Ticket.Unassigned') }}</div>
                </a>
            </div>
        </div>
    </div>

    <div v-if="showCreateTicket" class="modal-overlay" @@click.self="showCreateTicket = false">
        <div class="modal">
            <h2>{{ t('Project.NewTask') }}</h2>
            <div class="form-group">
                <label>{{ t('Ticket.TitleLabel') }}</label>
                <input v-model="newTicket.title" :placeholder="t('Ticket.TitlePlaceholder')" />
            </div>
            <div class="form-group">
                <label>{{ t('Ticket.DescriptionLabel') }}</label>
                <textarea v-model="newTicket.description" rows="3" :placeholder="t('Ticket.DescriptionPlaceholder')"></textarea>
            </div>
            <div class="form-group">
                <label>{{ t('Ticket.TypeLabel') }}</label>
                <select v-model="newTicket.type">
                    <option value="0">{{ t('Ticket.TypeTask') }}</option>
                    <option value="1">{{ t('Ticket.TypeBug') }}</option>
                    <option value="2">{{ t('Ticket.TypeFeature') }}</option>
                    <option value="3">{{ t('Ticket.TypeOther') }}</option>
                </select>
            </div>
            <div class="form-group">
                <label>{{ t('Ticket.PriorityLabel') }}</label>
                <select v-model="newTicket.priority">
                    <option value="0">{{ t('Ticket.PriorityLowest') }}</option>
                    <option value="1">{{ t('Ticket.PriorityLow') }}</option>
                    <option value="2">{{ t('Ticket.PriorityMedium') }}</option>
                    <option value="3">{{ t('Ticket.PriorityHigh') }}</option>
                    <option value="4">{{ t('Ticket.PriorityHighest') }}</option>
                </select>
            </div>
            <div class="form-group">
                <label>{{ t('Ticket.AssignToLabel') }}</label>
                <select v-model="newTicket.assigneeId">
                    <option :value="null">—</option>
                    <option v-for="u in users" :key="u.id" :value="u.id">{{ u.displayName }}</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" @@click="showCreateTicket = false">{{ t('Projects.Cancel') }}</button>
                <button class="btn btn-primary" @@click="createTicket">{{ t('Projects.Create') }}</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
const projectId = @Model;
const { createApp } = Vue;
const statusKeys = { 0: 'Ticket.StatusToDo', 1: 'Ticket.StatusInProgress', 2: 'Ticket.StatusInReview', 3: 'Ticket.StatusDone' };
const priorityKeys = { 0: 'Ticket.PriorityLowest', 1: 'Ticket.PriorityLow', 2: 'Ticket.PriorityMedium', 3: 'Ticket.PriorityHigh', 4: 'Ticket.PriorityHighest' };
const typeKeys = { 0: 'Ticket.TypeTask', 1: 'Ticket.TypeBug', 2: 'Ticket.TypeFeature', 3: 'Ticket.TypeOther' };
createApp({
    data() {
        return {
            projectId,
            project: null,
            tickets: [],
            users: [],
            loading: true,
            error: null,
            showCreateTicket: false,
            newTicket: { title: '', description: '', type: 0, priority: 2, assigneeId: null },
            dragOverColumn: null,
            draggedTicket: null,
            translations: {}
        };
    },
    computed: {
        columns() {
            return [
                { type: 0, label: this.t('Ticket.TypeTask') },
                { type: 1, label: this.t('Ticket.TypeBug') },
                { type: 2, label: this.t('Ticket.TypeFeature') },
                { type: 3, label: this.t('Ticket.TypeOther') }
            ];
        }
    },
    mounted() {
        this.loadTranslations().then(() => { this.load(); });
        fetch('/api/UsersApi').then(r => r.json()).then(u => this.users = u).catch(() => {});
    },
    methods: {
        async loadTranslations() {
            const locale = document.documentElement.lang || 'pl';
            try {
                const r = await fetch('/locales/' + locale + '.json');
                if (r.ok) this.translations = await r.json();
            } catch (_) {}
        },
        t(key, ...args) {
            let s = this.translations[key] ?? key;
            args.forEach((val, i) => { s = s.replace(new RegExp('\\{' + i + '\\}', 'g'), val); });
            return s;
        },
        normalizeType(v) {
            const n = typeof v === 'string' ? parseInt(v, 10) : Number(v);
            if (Number.isNaN(n) || n < 0 || n > 3) return 0;
            return n;
        },
        ticketsByType(type) {
            return this.tickets.filter(t => this.normalizeType(t.type) === type);
        },
        statusLabel(s) { return this.t(statusKeys[this.normalizeStatus(s)] ?? 'Ticket.StatusToDo'); },
        statusClass(s) {
            const c = { 0: 'todo', 1: 'progress', 2: 'review', 3: 'done' };
            return c[this.normalizeStatus(s)] ?? 'todo';
        },
        normalizeStatus(s) {
            const n = typeof s === 'string' ? parseInt(s, 10) : Number(s);
            if (Number.isNaN(n) || n < 0 || n > 3) return 0;
            return n;
        },
        priorityLabel(p) { return this.t(priorityKeys[p] ?? 'Ticket.PriorityMedium'); },
        priorityClass(p) {
            const c = { 0: 'lowest', 1: 'low', 2: 'medium', 3: 'high', 4: 'highest' };
            return c[p] ?? 'medium';
        },
        async load() {
            try {
                this.loading = true;
                this.error = null;
                const [pRes, tRes] = await Promise.all([
                    fetch('/api/ProjectsApi/' + projectId),
                    fetch('/api/TicketsApi?projectId=' + projectId)
                ]);
                if (!pRes.ok) throw new Error(this.t('Project.ErrorLoad'));
                if (!tRes.ok) throw new Error(this.t('Project.ErrorLoadTickets'));
                this.project = await pRes.json();
                const rawTickets = await tRes.json();
                this.tickets = rawTickets.map(t => ({
                    ...t,
                    status: this.normalizeStatus(t.status),
                    type: this.normalizeType(t.type)
                }));
            } catch (e) {
                this.error = e.message;
            } finally {
                this.loading = false;
            }
        },
        onDragStart(ev, ticket) {
            this.draggedTicket = ticket;
            ev.dataTransfer.effectAllowed = 'move';
            ev.dataTransfer.setData('text/plain', ticket.id);
            ev.target.classList.add('kanban-card--dragging');
        },
        onDragEnd(ev) {
            ev.target.classList.remove('kanban-card--dragging');
            this.draggedTicket = null;
            this.dragOverColumn = null;
        },
        onDragOver(ev, type) {
            if (this.draggedTicket && this.normalizeType(this.draggedTicket.type) !== type) {
                this.dragOverColumn = type;
            }
        },
        onDragLeave(ev) {
            if (!ev.currentTarget.contains(ev.relatedTarget)) {
                this.dragOverColumn = null;
            }
        },
        async onDrop(ev, newType) {
            ev.preventDefault();
            this.dragOverColumn = null;
            const ticketId = ev.dataTransfer.getData('text/plain');
            if (!ticketId || !this.draggedTicket) return;
            const ticket = this.tickets.find(t => t.id === parseInt(ticketId, 10));
            if (!ticket || this.normalizeType(ticket.type) === newType) return;
            try {
                const r = await fetch('/api/TicketsApi/' + ticketId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: newType })
                });
                if (!r.ok) throw new Error(this.t('Ticket.ErrorUpdate'));
                ticket.type = newType;
            } catch (e) {
                alert(e.message);
            }
        },
        async createTicket() {
            if (!this.newTicket.title.trim()) return;
            try {
                const r = await fetch('/api/TicketsApi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: this.newTicket.title,
                        description: this.newTicket.description || null,
                        projectId,
                        reporterId: 1,
                        assigneeId: this.newTicket.assigneeId || null,
                        type: parseInt(this.newTicket.type, 10),
                        priority: parseInt(this.newTicket.priority, 10)
                    })
                });
                if (!r.ok) throw new Error(this.t('Project.ErrorCreateTicket'));
                this.showCreateTicket = false;
                this.newTicket = { title: '', description: '', type: 0, priority: 2, assigneeId: null };
                await this.load();
            } catch (e) {
                alert(e.message);
            }
        }
    }
}).mount('#app');
</script>
}
